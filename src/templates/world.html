<style>
    #uie-world-window{ top: 80px; left: 80px; transform:none; }
    @media (max-width: 700px), (pointer: coarse) {
        #uie-world-window {
            position: fixed !important;
            inset: auto !important;
            top: 12vh !important;
            left: 3vw !important;
            transform: none !important;
            width: 94vw !important;
            height: 80vh !important;
            max-width: 94vw !important;
            max-height: 80vh !important;
        }
    }
</style>
<div id="uie-world-window" class="uie-window" style="display:none; width: min(720px, 92vw); height: min(820px, 92vh); background: #0b0f15; flex-direction:column; z-index:10010;">
    
    <div class="uie-header" style="border-bottom: 1px solid #cba35c; padding: 10px; background: linear-gradient(90deg, #1b202b, #0e121a);">
        <div class="uie-info">
            <h2 style="margin:0; font-family:'Cinzel',serif; color:#cba35c;">REALITY ENGINE</h2>
            <div style="font-size:0.7em; color:#666;">SIMULATION_ID: <span id="uie-world-id">NULL</span></div>
        </div>
        <div class="uie-controls">
            <i class="fa-solid fa-circle-question" onclick="uie.phone.openBooksGuide('guide-map')" title="Help" style="cursor:pointer; color:#cba35c; margin-right:10px;"></i>
            <i class="fa-solid fa-arrows-rotate" id="uie-world-update" title="AI Update (Scan Chat)" style="cursor:pointer; color:#cba35c; margin-right:10px;"></i>
            <i class="fa-solid fa-layer-group" id="uie-world-projector" title="Projector Mode" style="cursor:pointer; color:#cba35c; margin-right:10px;"></i>
            <i class="fa-solid fa-xmark uie-close-btn" id="uie-world-close"></i>
        </div>
    </div>

    <div id="uie-world-content" class="custom-scroll" style="flex:1; padding:15px; overflow-y:auto; position:relative;">
        <div style="text-align:center; margin-top:50%; transform:translateY(-50%); color:#333;">
            <i class="fa-solid fa-terminal" style="font-size:3em; margin-bottom:10px;"></i>
            <p>AWAITING INPUT...</p>
        </div>
    </div>

    <div style="padding:10px; background:#111; border-top:1px solid #333; display:flex; gap:10px;">
        <input type="text" id="uie-world-input" placeholder="What should I simulate? (e.g. 'My Magic Shop' or 'Zombie Base')" style="flex:1; background:#000; border:1px solid #333; color:#cba35c; padding:10px; font-family:monospace;">
        <button id="uie-world-gen" style="background:#cba35c; color:#000; font-weight:bold; border:none; padding:0 15px; cursor:pointer;"><i class="fa-solid fa-bolt"></i></button>
    </div>
</div>

<style>
    :root {
        --re-color-bg: #0f0a0a;
        --re-color-border: #3d2b25;
        --re-color-text: #c0b0a0;
        --re-color-accent: #cd7f32;
    }

    #reality-stage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100dvh;
        background: var(--re-color-bg);
        overflow: hidden;
        z-index: 999;
        display: none;
        touch-action: manipulation;
    }

    body[data-reality-stage="1"] #chat,
    body[data-reality-stage="1"] #sheld,
    body[data-reality-stage="1"] #chatwrap,
    body[data-reality-stage="1"] #chat_wrap {
        opacity: 0 !important;
        pointer-events: none !important;
    }

    #re-bg {
        position: absolute;
        inset: 0;
        background:
            radial-gradient(120% 120% at 40% 20%, rgba(40, 24, 16, 0.55) 0%, rgba(10, 6, 5, 0.70) 60%, rgba(0, 0, 0, 0.92) 100%),
            linear-gradient(180deg, #14121c, #0b0f15);
        filter: saturate(0.95);
    }

    #re-weather{
        position:absolute;
        inset:0;
        pointer-events:none;
        mix-blend-mode: screen;
        opacity: 0.0;
        z-index: 2;
    }

    #re-bg::before {
        content: "";
        position: absolute;
        inset: 0;
        display: none;
        pointer-events: none;
    }

    #reality-stage.re-shake {
        animation: reShake 420ms;
    }
    @keyframes reShake {
        0% { transform: translate(0, 0); }
        15% { transform: translate(-2px, 1px); }
        30% { transform: translate(2px, -1px); }
        45% { transform: translate(-1px, -2px); }
        60% { transform: translate(1px, 2px); }
        75% { transform: translate(-1px, 1px); }
        100% { transform: translate(0, 0); }
    }

    #re-sprite {
        position: absolute;
        left: 50%;
        bottom: 22dvh;
        transform: translateX(-50%);
        height: 62dvh;
        width: auto;
        max-width: 96vw;
        object-fit: contain;
        display: none;
        pointer-events: none;
        filter: drop-shadow(0 12px 28px rgba(0,0,0,0.65));
        animation: reBreathe 4.8s ease-in-out infinite;
    }
    @keyframes reBreathe {
        0%, 100% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.01); }
    }

    #re-objects {
        position: absolute;
        inset: 0;
        pointer-events: none;
    }

    .re-obj {
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        backdrop-filter: blur(10px);
        display: grid;
        place-items: center;
        pointer-events: auto;
        touch-action: manipulation;
        box-shadow: 0 10px 26px rgba(0,0,0,0.55);
    }

    .re-obj i {
        font-size: 26px;
        color: rgba(255,220,190,0.92);
        opacity: 0.95;
        pointer-events: none;
    }

    #re-phone {
        left: 14px;
        bottom: 18dvh;
    }

    #re-journal {
        right: 14px;
        bottom: 18dvh;
    }

    #re-ui {
        position: absolute;
        inset: 0;
        pointer-events: none;
        display: flex;
        flex-direction: column;
    }

    #re-hud {
        pointer-events: auto;
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 12px 12px 6px;
    }

    .re-bar {
        flex: 1;
        min-width: 0;
        border-radius: 14px;
        border: 1px solid rgba(61, 43, 37, 0.8);
        background: rgba(0, 0, 0, 0.22);
        overflow: hidden;
        height: 14px;
    }

    .re-bar > div {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(205,127,50,0.85), rgba(241,196,15,0.85));
    }

    .re-hud-btn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        color: var(--re-color-text);
        font-weight: 900;
        display: grid;
        place-items: center;
        pointer-events: auto;
        touch-action: manipulation;
    }

    .vn-dialogue-box {
        pointer-events: auto;
        width: min(820px, 96vw);
        margin: auto auto 80px;
        background: rgba(15, 10, 10, 0.95);
        border: 2px solid var(--re-color-border);
        border-radius: 18px;
        padding: 14px;
        color: var(--re-color-text);
        box-shadow: 0 20px 40px rgba(0,0,0,0.65);
    }

    #re-speaker {
        font-weight: 900;
        letter-spacing: 0.6px;
        color: rgba(205,127,50,0.95);
        margin-bottom: 8px;
        text-transform: uppercase;
        font-family: serif;
    }

    #re-text {
        font-size: 1rem;
        line-height: 1.35;
        white-space: pre-wrap;
        word-break: break-word;
        min-height: 2.6em;
    }

    #re-composer-wrap{
        position:absolute;
        left:50%;
        bottom:max(10px, env(safe-area-inset-bottom));
        transform:translateX(-50%);
        width:min(820px, 96vw);
        pointer-events:auto;
    }

    #re-action-grid{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        padding:10px 0 6px;
        justify-content:center;
    }
    .re-actbtn{
        height:44px;
        padding:0 14px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.22);
        color:rgba(255,220,190,0.92);
        font-weight:900;
        cursor:pointer;
        touch-action:manipulation;
    }
    #re-composer{
        display:flex;
        gap:10px;
        align-items:flex-end;
        padding:10px;
        border-radius:18px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.30);
        backdrop-filter: blur(10px);
    }
    #re-user-input{
        flex:1;
        min-width:0;
        min-height:44px;
        max-height:120px;
        resize:none;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.25);
        color:var(--re-color-text);
        padding:10px 12px;
        outline:none;
        font-size:1rem;
        line-height:1.2;
    }
    .re-quick{
        display:flex;
        gap:8px;
        align-items:center;
    }
    .re-qbtn{
        width:44px;
        height:44px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.25);
        color:rgba(255,220,190,0.92);
        display:grid;
        place-items:center;
        font-weight:900;
        cursor:pointer;
        touch-action:manipulation;
    }
    #re-st-menu{
        position:fixed;
        width:min(320px, 86vw);
        display:none;
        flex-direction:column;
        gap:8px;
        padding:10px;
        border-radius:16px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(15,10,10,0.96);
        box-shadow:0 20px 40px rgba(0,0,0,0.75);
        z-index: 10001;
    }
    .re-menu-item{
        display:flex;
        gap:10px;
        align-items:center;
        padding:10px 10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,0.10);
        background:rgba(0,0,0,0.22);
        color:var(--re-color-text);
        font-weight:900;
        cursor:pointer;
    }
    .re-menu-item span{ margin-left:auto; opacity:0.75; font-size:12px; }

    #re-forge-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        height: 40px;
        padding: 0 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.30);
        color: var(--re-color-accent);
        font-weight: 900;
        letter-spacing: 0.5px;
        pointer-events: auto;
        touch-action: manipulation;
        display: block;
    }

    #re-map {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: none;
        image-rendering: pixelated;
        touch-action: manipulation;
    }

    #re-forge-modal {
        position: absolute;
        inset: 0;
        display: none;
        pointer-events: auto;
        background: rgba(0,0,0,0.65);
        align-items: center;
        justify-content: center;
        padding: 12px;
    }

    #re-forge-card {
        width: min(640px, 96vw);
        max-height: calc(100dvh - 24px);
        overflow: auto;
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(15, 10, 10, 0.96);
        padding: 12px;
        color: var(--re-color-text);
    }

    #re-forge-card textarea {
        width: 100%;
        height: 120px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        color: var(--re-color-text);
        padding: 10px 12px;
        resize: vertical;
        outline: none;
    }

    #re-forge-preview {
        width: 100%;
        height: 220px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(0,0,0,0.22);
        margin-top: 10px;
        overflow: hidden;
        display: grid;
        place-items: center;
    }

    #re-forge-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
    }

    .re-forge-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .re-forge-btn {
        height: 44px;
        padding: 0 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        color: var(--re-color-text);
        font-weight: 900;
        cursor: pointer;
        touch-action: manipulation;
    }

    .re-forge-btn.primary {
        background: rgba(205,127,50,0.22);
        border-color: rgba(205,127,50,0.35);
        color: rgba(255,220,190,0.98);
    }

    @media (max-width: 768px) {
        #re-sprite {
            height: 50dvh;
            bottom: 25dvh;
        }

        .vn-dialogue-box {
            width: 95%;
            margin-bottom: 80px;
            font-size: 1rem;
            padding: 15px;
        }

        #re-phone { left: 10px; }
        #re-journal { right: 10px; }
        .re-obj { width: 60px; height: 60px; bottom: 18dvh; }
    }
</style>

<div id="reality-stage" aria-hidden="true">
    <div id="re-bg"></div>
    <div id="re-weather"></div>
    <canvas id="re-map"></canvas>
    <img id="re-sprite" alt="">
    <div id="re-objects">
        <button class="re-obj" id="re-phone" title="Phone" style="display:none;"><i class="fa-solid fa-phone"></i></button>
        <button class="re-obj" id="re-journal" title="Journal" style="display:none;"><i class="fa-solid fa-book"></i></button>
    </div>
    <div id="re-ui">
        <div id="re-hud">
            <div class="re-bar" title="HP"><div id="re-hp-fill"></div></div>
            <div class="re-bar" title="Stress"><div id="re-stress-fill"></div></div>
            <button class="re-hud-btn" id="re-toggle-view" title="Toggle Map"><i class="fa-solid fa-map"></i></button>
            <button class="re-hud-btn" id="re-exit" title="Exit"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <button id="re-forge-btn">Forge</button>
        <div class="vn-dialogue-box" id="re-vn-box">
            <div id="re-speaker"></div>
            <div id="re-text"></div>
        </div>
        <div id="re-composer-wrap">
            <div id="re-action-grid"></div>
            <div id="re-composer">
                <textarea id="re-user-input" placeholder="Type a reply..."></textarea>
                <div class="re-quick" id="re-quick">
                    <button class="re-qbtn" id="re-q-menu" title="Menu"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                    <button class="re-qbtn" id="re-q-chatbox" title="Chat Log"><i class="fa-solid fa-message"></i></button>
                    <button class="re-qbtn" id="re-q-send" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
            <div id="re-st-menu">
                <div class="re-menu-item" id="re-act-forge"><i class="fa-solid fa-wand-magic-sparkles"></i> Forge Background</div>
                <div class="re-menu-item" id="re-act-toggle-map"><i class="fa-solid fa-map"></i> Toggle Map</div>
                <div class="re-menu-item" id="re-act-st-menu"><i class="fa-solid fa-bars"></i> Chat Menu</div>
                <div class="re-menu-item" id="re-act-author"><i class="fa-solid fa-pen-nib"></i> Author's Note</div>
                <div class="re-menu-item" id="re-act-cfg"><i class="fa-solid fa-scale-balanced"></i> CFG Scale</div>
                <div class="re-menu-item" id="re-act-tokens"><i class="fa-solid fa-chart-pie"></i> Token Probabilities</div>
                <div class="re-menu-item" id="re-act-newchat"><i class="fa-solid fa-comment"></i> Start New Chat</div>
                <div class="re-menu-item" id="re-act-manage"><i class="fa-solid fa-folder-open"></i> Manage Chat Files</div>
                <div class="re-menu-item" id="re-act-delete"><i class="fa-solid fa-trash"></i> Delete Messages</div>
                <div class="re-menu-item" id="re-act-closechat"><i class="fa-solid fa-xmark"></i> Close Chat</div>
                <div class="re-menu-item" id="re-act-regenerate"><i class="fa-solid fa-rotate-right"></i> Regenerate</div>
                <div class="re-menu-item" id="re-act-continue"><i class="fa-solid fa-forward"></i> Continue</div>
                <div class="re-menu-item" id="re-act-impersonate"><i class="fa-solid fa-user-pen"></i> Impersonate</div>
                <div class="re-menu-item" id="re-act-stop"><i class="fa-solid fa-stop"></i> Stop</div>
            </div>
        </div>
        <div id="re-forge-modal">
            <div id="re-forge-card">
                <div style="display:flex; gap:10px; align-items:center;">
                    <div style="font-weight:900; letter-spacing:0.8px; color:rgba(205,127,50,0.98);">WORLD FORGE</div>
                    <button class="re-forge-btn" id="re-forge-close" style="margin-left:auto;"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div style="opacity:0.75; font-size:12px; margin-top:6px;">Edit the prompt, generate a background, then bind it to this location.</div>
                <textarea id="re-forge-prompt" placeholder="Describe the scene background..."></textarea>
                <div class="re-forge-row">
                    <button class="re-forge-btn primary" id="re-forge-generate"><i class="fa-solid fa-wand-magic-sparkles"></i>&nbsp;Generate</button>
                    <button class="re-forge-btn" id="re-forge-bind"><i class="fa-solid fa-floppy-disk"></i>&nbsp;Save/Bind</button>
                </div>
                <div id="re-forge-preview">
                    <img id="re-forge-img" alt="">
                    <div id="re-forge-empty" style="opacity:0.7; font-weight:900;">No preview yet</div>
                </div>
            </div>
        </div>
    </div>
</div>
