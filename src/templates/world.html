<style>
    #uie-world-window{ top: 80px; left: 80px; transform:none; }
    @media (max-width: 700px), (pointer: coarse) {
        #uie-world-window {
            position: fixed !important;
            inset: auto !important;
            top: 12vh !important;
            left: 3vw !important;
            transform: none !important;
            width: 94vw !important;
            height: 80vh !important;
            max-width: 94vw !important;
            max-height: 80vh !important;
        }
    }
</style>
<div id="uie-world-window" class="uie-window" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width: min(720px, 92vw); height: min(820px, 92vh); background: #0b0f15; flex-direction:column; z-index:20050;">

    <div class="uie-header" style="border-bottom: 1px solid #cba35c; padding: 10px; background: linear-gradient(90deg, #1b202b, #0e121a);">
        <div class="uie-info">
            <h2 style="margin:0; font-family:'Cinzel',serif; color:#cba35c;">REALITY ENGINE</h2>
            <div style="font-size:0.7em; color:#666;">SIMULATION_ID: <span id="uie-world-id">NULL</span></div>
        </div>
        <div class="uie-controls">
            <i class="fa-solid fa-circle-question" onclick="uie.phone.openBooksGuide('guide-map')" title="Help" style="cursor:pointer; color:#cba35c; margin-right:10px;"></i>
            <i class="fa-solid fa-arrows-rotate" id="uie-world-update" title="AI Update (Scan Chat)" style="cursor:pointer; color:#cba35c; margin-right:10px;"></i>
            <i class="fa-solid fa-layer-group" id="uie-world-projector" title="Projector Mode" style="cursor:pointer; color:#cba35c; margin-right:10px;"></i>
            <i class="fa-solid fa-xmark uie-close-btn" id="uie-world-close"></i>
        </div>
    </div>

    <div id="uie-world-content" class="custom-scroll" style="flex:1; padding:15px; overflow-y:auto; position:relative;">
        <div style="text-align:center; margin-top:50%; transform:translateY(-50%); color:#333;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3em; margin-bottom:10px; opacity:0.5;"></i>
            <h3 style="margin:5px 0; color:#cba35c;">INITIALIZING...</h3>
        </div>
    </div>

    <div style="padding:10px; background:#111; border-top:1px solid #333; display:none; gap:10px;">
        <input type="text" id="uie-world-input" placeholder="What should I simulate? (e.g. 'My Magic Shop' or 'Zombie Base')" style="flex:1; background:#000; border:1px solid #333; color:#cba35c; padding:10px; font-family:monospace;">
        <button id="uie-world-gen" style="background:#cba35c; color:#000; font-weight:bold; border:none; padding:0 15px; cursor:pointer;"><i class="fa-solid fa-bolt"></i></button>
    </div>
</div>

<div id="re-quick-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2147483647; align-items:center; justify-content:center;">
    <div style="background:#111; border:1px solid #444; padding:20px; border-radius:12px; width:300px; display:flex; flex-direction:column; gap:10px; color:#fff;">
        <h3 style="margin:0; color:#cba35c;">Add Quick Button</h3>
        <input type="text" id="re-quick-label" placeholder="Button Label (e.g. 'Attack')" style="background:#222; border:1px solid #555; color:#fff; padding:8px; border-radius:6px;">
        <input type="text" id="re-quick-icon" placeholder="Icon (e.g. fa-sword) [Optional]" style="background:#222; border:1px solid #555; color:#fff; padding:8px; border-radius:6px;">
        <textarea id="re-quick-prompt" placeholder="Action/Text to send..." style="background:#222; border:1px solid #555; color:#fff; padding:8px; border-radius:6px; min-height:80px; resize:vertical;"></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:5px;">
            <button id="re-quick-cancel" style="background:transparent; border:1px solid #666; color:#ccc; padding:6px 12px; border-radius:6px; cursor:pointer;">Cancel</button>
            <button id="re-quick-save" style="background:#cba35c; border:none; color:#000; font-weight:bold; padding:6px 12px; border-radius:6px; cursor:pointer;">Save</button>
        </div>
    </div>
</div>

<template id="uie-world-state-view">
    <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="font-weight:900; color:#cba35c;">World State</div>
        <div class="world-state-grid" style="display:grid; grid-template-columns: 140px 1fr; gap:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
            <div style="opacity:0.75;">Location</div><div class="val-loc" style="font-weight:900;"></div>
            <div style="opacity:0.75;">Time</div><div class="val-time" style="font-weight:900;"></div>
            <div style="opacity:0.75;">Weather</div><div class="val-weather" style="font-weight:900;"></div>
            <div style="opacity:0.75;">Threat</div><div class="val-threat" style="font-weight:900;"></div>
            <div style="opacity:0.75;">Status</div><div class="val-status" style="font-weight:900;"></div>
        </div>
        <div style="opacity:0.75; font-size:12px;">
            Updates automatically from chat when AI automation is on. Use refresh to scan immediately.
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="uie-world-toggle-re" style="height:44px; padding:0 14px; border-radius:14px; border:1px solid rgba(203,163,92,0.35); background:rgba(0,0,0,0.25); color:#cba35c; font-weight:900; cursor:pointer;">Projector</button>
            <button id="uie-world-toggle-room" style="height:44px; padding:0 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.18); color:#fff; font-weight:900; cursor:pointer;">Room</button>
            <button id="uie-world-toggle-map" style="height:44px; padding:0 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.18); color:#fff; font-weight:900; cursor:pointer;">Map</button>
        </div>
        <label style="display:flex; gap:10px; align-items:center; font-weight:900; color:#fff;">
            <input type="checkbox" id="uie-world-hide-quick">
            Hide quick buttons (Phone/Journal/Chatbox/Menu)
        </label>
        <label style="display:flex; gap:10px; align-items:center; font-weight:900; color:#fff;">
            <input type="checkbox" id="uie-world-hide-hud">
            Hide HUD (HP/Stress bars)
        </label>
        <label style="display:flex; gap:10px; align-items:center; font-weight:900; color:#fff;">
            <input type="checkbox" id="uie-world-show-st-ui">
            Show SillyTavern UI behind stage
        </label>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="uie-world-open-sprites" style="height:44px; padding:0 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.25); color:#fff; font-weight:900; cursor:pointer;">Sprite Library</button>
            <button id="uie-world-open-mods" style="display:none; height:44px; padding:0 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.25); color:#fff; font-weight:900; cursor:pointer;">User Mods</button>
        </div>
    </div>
</template>

<style>
    :root {
        --re-color-bg: #0f0a0a;
        --re-color-border: #3d2b25;
        --re-color-text: #c0b0a0;
        --re-color-accent: #cd7f32;
    }

    #reality-stage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100dvh;
        background: var(--re-color-bg);
        overflow: hidden;
        z-index: 2147483640; /* Maximize Z-Index to cover everything */
        display: none;
        pointer-events: auto;
        touch-action: manipulation;
    }

    /* When ST UI is shown behind the stage, do NOT let the stage itself eat clicks.
       This fixes blocked clicks on the SillyTavern launcher/system menu. */
    body:not([data-reality-stage="1"]) #reality-stage {
        pointer-events: none;
    }

    /* Aggressively hide SillyTavern UI elements when stage is active */
    body[data-reality-stage="1"] #chat,
    body[data-reality-stage="1"] #sheld,
    body[data-reality-stage="1"] #chatwrap,
    body[data-reality-stage="1"] #chat_wrap,
    body[data-reality-stage="1"] #quick-reply-container,
    body[data-reality-stage="1"] .quick-reply-container,
    body[data-reality-stage="1"] #quick_reply_container,
    body[data-reality-stage="1"] .quick_reply_container,
    body[data-reality-stage="1"] #chat_options,
    body[data-reality-stage="1"] .qr-container,
    body[data-reality-stage="1"] [id*="quick-reply"],
    body[data-reality-stage="1"] [class*="quick-reply"] {
        opacity: 0 !important;
        pointer-events: none !important;
        display: none !important;
        visibility: hidden !important;
        z-index: -1 !important;
    }

    #re-bg {
        position: absolute;
        inset: 0;
        background:
            radial-gradient(120% 120% at 40% 20%, rgba(40, 24, 16, 0.55) 0%, rgba(10, 6, 5, 0.70) 60%, rgba(0, 0, 0, 0.92) 100%),
            linear-gradient(180deg, #14121c, #0b0f15);
        filter: saturate(0.95);
    }

    #re-weather{
        position:absolute;
        inset:0;
        pointer-events:none;
        mix-blend-mode: screen;
        opacity: 0.0;
        z-index: 2;
    }

    #re-bg::before {
        content: "";
        position: absolute;
        inset: 0;
        display: none;
        pointer-events: none;
    }

    #reality-stage.re-shake {
        animation: reShake 420ms;
    }
    @keyframes reShake {
        0% { transform: translate(0, 0); }
        15% { transform: translate(-2px, 1px); }
        30% { transform: translate(2px, -1px); }
        45% { transform: translate(-1px, -2px); }
        60% { transform: translate(1px, 2px); }
        75% { transform: translate(-1px, 1px); }
        100% { transform: translate(0, 0); }
    }

    #re-sprites-layer {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
    }

    .re-sprite {
        position: absolute;
        left: 50%;
        bottom: 22dvh;
        transform: translateX(-50%);
        height: 62dvh;
        width: auto;
        max-width: 96vw;
        object-fit: contain;
        filter: drop-shadow(0 12px 28px rgba(0,0,0,0.65));
        animation: reBreathe 4.8s ease-in-out infinite;
        transition: all 0.5s ease-in-out;
    }
    @keyframes reBreathe {
        0%, 100% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.01); }
    }

    #re-objects {
        position: absolute;
        inset: 0;
        pointer-events: none;
    }

    .re-obj {
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        backdrop-filter: blur(10px);
        display: grid;
        place-items: center;
        pointer-events: auto;
        touch-action: manipulation;
        box-shadow: 0 10px 26px rgba(0,0,0,0.55);
    }

    .re-obj i {
        font-size: 26px;
        color: rgba(255,220,190,0.92);
        opacity: 0.95;
        pointer-events: none;
    }

    #re-phone {
        left: 14px;
        bottom: 18dvh;
    }

    #re-journal {
        right: 14px;
        bottom: 18dvh;
    }

    #re-ui {
        position: absolute;
        inset: 0;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        z-index: 120;
    }

    #re-hud {
        pointer-events: auto;
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 12px 12px 6px;
    }

    .re-bar {
        flex: 1;
        min-width: 0;
        border-radius: 14px;
        border: 1px solid rgba(61, 43, 37, 0.8);
        background: rgba(0, 0, 0, 0.22);
        overflow: hidden;
        height: 14px;
    }

    .re-bar > div {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(205,127,50,0.85), rgba(241,196,15,0.85));
    }

    .re-hud-btn {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        color: var(--re-color-text);
        font-weight: 900;
        display: grid;
        place-items: center;
        pointer-events: auto;
        touch-action: manipulation;
    }

    /* VN Box styles deferred to style.css for cleaner overriding */
    #re-vn-box {
        position: absolute;
        bottom: 35vh;
        left: 50%;
        transform: translateX(-50%);
        width: 800px;
        max-width: 95vw;
        background: rgba(16, 12, 12, 0.95);
        border: 1px solid rgba(203, 163, 92, 0.3);
        border-radius: 12px;
        padding: 20px 20px 40px 20px;
        display: none;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        z-index: 2147483643; /* Above arrows (wait, arrows are 2147483642? No, let arrows be on top?) */
        /* User said south button not visible to box. If box covers button, button is hidden.
           If button is z=...42 and box is z=...43, box covers button.
           If button is at bottom:110px and box is bottom:35vh (~350px on 1080p), they don't overlap.
           But to be safe, let's keep box lower z-index than arrows if they overlap?
           Arrows should be interactable.
           Let's set box z-index to 100. Arrows are ...42. Arrows win.
        */
        z-index: 100;
        min-height: 120px;
    }

    #re-speaker {
        font-weight: 900;
        color: #cba35c;
        font-size: 1.1em;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }

    #re-text {
        color: #e0d0c0;
        font-size: 1.1em;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    #re-composer-wrap{
        position:absolute;
        left:50%;
        bottom:max(10px, env(safe-area-inset-bottom));
        transform:translateX(-50%);
        width:min(820px, 96vw);
        pointer-events:auto;
        z-index: 120;
    }

    @media (max-width: 700px), (pointer: coarse) {
        #re-composer-wrap{
            position:fixed !important;
            bottom: 10px !important;
            z-index: 2147483645 !important;
            display: flex !important;
            visibility: visible !important;
        }
        #re-hud {
            z-index: 2147483645 !important;
            position: relative !important;
        }
    }

    #re-action-grid{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        padding:10px 0 6px;
        justify-content:center;
    }
    .re-actbtn{
        height:44px;
        padding:0 14px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.22);
        color:rgba(255,220,190,0.92);
        font-weight:900;
        cursor:pointer;
        touch-action:manipulation;
    }
    #re-composer{
        display:flex;
        gap:10px;
        align-items:flex-end;
        padding:10px;
        border-radius:18px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.30);
        backdrop-filter: blur(10px);
    }
    #re-user-input{
        flex:1;
        min-width:0;
        min-height:44px;
        max-height:120px;
        resize:none;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.25);
        color:var(--re-color-text);
        padding:10px 12px;
        outline:none;
        font-size:1rem;
        line-height:1.2;
    }
    .re-quick{
        display:flex;
        gap:8px;
        align-items:center;
    }
    .re-qbtn{
        width:44px;
        height:44px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(0,0,0,0.25);
        color:rgba(255,220,190,0.92);
        display:grid;
        place-items:center;
        font-weight:900;
        cursor:pointer;
        touch-action:manipulation;
    }
    #re-st-menu{
        position:fixed;
        width:min(320px, 86vw);
        display:none;
        flex-direction:column;
        gap:8px;
        padding:10px;
        border-radius:16px;
        border:1px solid rgba(255,255,255,0.14);
        background:rgba(15,10,10,0.96);
        box-shadow:0 20px 40px rgba(0,0,0,0.75);
        z-index: 2147483647;
        pointer-events: auto;
    }
    .re-menu-item{
        display:flex;
        gap:10px;
        align-items:center;
        padding:10px 10px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,0.10);
        background:rgba(0,0,0,0.22);
        color:var(--re-color-text);
        font-weight:900;
        cursor:pointer;
    }
    .re-menu-item span{ margin-left:auto; opacity:0.75; font-size:12px; }

    #re-forge-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        height: 40px;
        padding: 0 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.30);
        color: var(--re-color-accent);
        font-weight: 900;
        letter-spacing: 0.5px;
        pointer-events: auto;
        touch-action: manipulation;
        display: block;
        z-index: 19050;
    }

    #re-map {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: none;
        image-rendering: pixelated;
        touch-action: manipulation;
    }

    #re-forge-modal {
        position: fixed;
        inset: 0;
        display: none;
        pointer-events: auto;
        background: rgba(0,0,0,0.65);
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 2147483647;
    }

    #re-forge-card {
        width: min(640px, 96vw);
        max-height: calc(100dvh - 24px);
        max-height: calc(100svh - 24px);
        max-height: calc(100vh - 24px);
        overflow: auto;
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(15, 10, 10, 0.96);
        padding: 12px;
        color: var(--re-color-text);
    }

    #re-forge-card textarea {
        width: 100%;
        height: 120px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        color: var(--re-color-text);
        padding: 10px 12px;
        resize: vertical;
        outline: none;
    }

    #re-forge-preview {
        width: 100%;
        height: 220px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(0,0,0,0.22);
        margin-top: 10px;
        overflow: hidden;
        display: grid;
        place-items: center;
    }

    #re-forge-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
    }

    #re-quick-modal,
    #re-vn-settings-modal {
        position: fixed !important;
        inset: 0 !important;
        height: 100dvh !important;
        height: 100svh !important;
        height: 100vh !important;
        padding-top: max(12px, env(safe-area-inset-top)) !important;
        padding-bottom: max(12px, env(safe-area-inset-bottom)) !important;
        padding-left: max(12px, env(safe-area-inset-left)) !important;
        padding-right: max(12px, env(safe-area-inset-right)) !important;
        align-items: center !important;
        justify-content: center !important;
        pointer-events: auto !important;
    }

    #re-quick-modal > div,
    #re-vn-settings-modal > div {
        width: min(420px, 94vw) !important;
        max-height: calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
        max-height: calc(100svh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
        max-height: calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
        overflow: auto !important;
    }

    #re-forge-modal {
        height: 100dvh !important;
        height: 100svh !important;
        height: 100vh !important;
        padding-top: max(12px, env(safe-area-inset-top)) !important;
        padding-bottom: max(12px, env(safe-area-inset-bottom)) !important;
        padding-left: max(12px, env(safe-area-inset-left)) !important;
        padding-right: max(12px, env(safe-area-inset-right)) !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .re-forge-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .re-forge-btn {
        height: 44px;
        padding: 0 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(0,0,0,0.25);
        color: var(--re-color-text);
        font-weight: 900;
        cursor: pointer;
        touch-action: manipulation;
    }

    .re-forge-btn.primary {
        background: rgba(205,127,50,0.22);
        border-color: rgba(205,127,50,0.35);
        color: rgba(255,220,190,0.98);
    }

    @media (max-width: 768px) {
        #re-sprite {
            height: 50dvh;
            bottom: 25dvh;
        }

        .vn-dialogue-box {
            width: 95%;
            margin-bottom: 0;
            font-size: 1rem;
            padding: 15px;
        }

        #re-phone { left: 10px; }
        #re-journal { right: 10px; }
        .re-obj { width: 60px; height: 60px; bottom: 18dvh; }
    }
</style>

<div id="reality-stage">
    <div id="re-bg"></div>
    <div id="re-weather"></div>
    <div id="re-map" style="position:absolute; inset:0; display:none;"></div>
    <canvas id="re-gesture-canvas" style="position:absolute; inset:0; pointer-events:none; z-index:90;"></canvas>
    <div id="re-sprites-layer"></div>
    <div id="re-ui">
        <div id="re-hud">
            <!-- Bars removed -->
            <button class="re-hud-btn" id="re-toggle-nav" title="Toggle Navigation"><i class="fa-solid fa-compass"></i></button>
            <button class="re-hud-btn" id="re-toggle-view" title="Toggle Map"><i class="fa-solid fa-map"></i></button>
            <button class="re-hud-btn" id="re-exit" title="Exit"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <button id="re-forge-btn">Forge</button>
        <div class="vn-dialogue-box" id="re-vn-box">
            <!-- Nameplate -->
            <div id="re-speaker"></div>

            <!-- Controls (Top Right) -->
            <div id="re-vn-controls" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; align-items:center;">
                <!-- Auto Mode Toggle (Moved here) -->
                <div id="re-vn-auto-toggle" title="Toggle Auto-Forward" style="font-size:0.8em; opacity:0.5; cursor:pointer; margin-right:5px; color:#c0b0a0;">
                    <i class="fa-solid fa-play"></i> Auto
                </div>
                <!-- Edit button removed per user request -->
                <div class="re-vn-btn" id="re-vn-settings" title="VN Settings"><i class="fa-solid fa-gear"></i></div>
            </div>

            <!-- Text Area -->
            <div id="re-text"></div>

            <!-- Nav Buttons (Split left/right) -->
            <div id="re-vn-prev" title="Back" style="position:absolute; left:10px; bottom:10px;"><i class="fa-solid fa-chevron-left"></i></div>
            <div id="re-vn-next" title="Next" style="position:absolute; right:10px; bottom:10px;"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <div id="re-composer-wrap">
            <div id="re-action-grid"></div>
            <div id="re-composer">
                <textarea id="re-user-input" placeholder="Type a reply..."></textarea>
                <div class="re-quick" id="re-quick">
                    <!-- Static System Buttons -->
                    <button class="re-qbtn" id="re-q-menu" title="Menu"><i class="fa-solid fa-bars"></i></button>
                    <button class="re-qbtn" id="re-q-scavenge" title="Inspect / Scavenge"><i class="fa-solid fa-magnifying-glass"></i></button>
                    <button class="re-qbtn" id="re-q-chatbox" title="Open Chatbox"><i class="fa-solid fa-comments"></i></button>
                    <button class="re-qbtn" id="re-q-add" title="Add Quick Action"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div id="re-st-menu">
            <div class="re-menu-item" id="re-act-continue"><i class="fa-solid fa-forward"></i> Continue</div>
            <div class="re-menu-item" id="re-act-regenerate"><i class="fa-solid fa-rotate-right"></i> Regenerate</div>
            <div class="re-menu-item" id="re-act-stop"><i class="fa-solid fa-stop"></i> Stop</div>
            <div class="re-menu-item" id="re-act-impersonate"><i class="fa-solid fa-user-pen"></i> Impersonate</div>
        </div>

        <!-- VN Settings Modal -->
        <div id="re-vn-settings-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2147483650; align-items:center; justify-content:center; pointer-events:auto;">
            <div style="background:#111; border:1px solid #444; padding:20px; border-radius:12px; width:320px; color:#fff;">
                <h3 style="margin:0 0 15px 0; color:#cba35c; border-bottom:1px solid #333; padding-bottom:10px;">VN Settings</h3>

                <label style="display:block; margin-bottom:10px; font-weight:bold;">
                    Text Speed (ms/char)
                    <input type="range" id="re-vn-speed" min="0" max="100" value="30" style="width:100%;">
                    <div style="font-size:0.8em; color:#888; text-align:right;">Lower is faster</div>
                </label>

                <label style="display:flex; gap:10px; align-items:center; margin-bottom:10px; font-weight:bold; cursor:pointer;">
                    <input type="checkbox" id="re-vn-auto-check">
                    Enable Auto-Advance
                </label>

                <label style="display:block; margin-bottom:10px; font-weight:bold;">
                    Words Per Box
                    <input type="number" id="re-vn-words" value="50" style="background:#222; border:1px solid #555; color:#fff; width:100%; padding:5px; border-radius:4px;">
                </label>

                <label style="display:block; margin-bottom:15px; font-weight:bold;">
                    Custom Prompt Prefix
                    <textarea id="re-vn-prompt" placeholder="e.g. (Visual Novel Style)" style="background:#222; border:1px solid #555; color:#fff; width:100%; height:60px; padding:5px; border-radius:4px; resize:vertical;"></textarea>
                </label>

                <div style="height:1px; background:#333; margin-bottom:15px;"></div>
                <h4 style="margin:0 0 10px 0; color:#cba35c;">Custom CSS</h4>

                <label style="display:block; margin-bottom:10px; font-weight:bold;">
                    User Bubble Style
                    <textarea id="re-vn-css-user" placeholder="background: blue; color: white;" style="background:#222; border:1px solid #555; color:#fff; width:100%; height:50px; padding:5px; border-radius:4px; font-family:monospace; resize:vertical;"></textarea>
                </label>

                <label style="display:block; margin-bottom:15px; font-weight:bold;">
                    AI Bubble Style
                    <textarea id="re-vn-css-ai" placeholder="background: red; color: white;" style="background:#222; border:1px solid #555; color:#fff; width:100%; height:50px; padding:5px; border-radius:4px; font-family:monospace; resize:vertical;"></textarea>
                </label>

                <div style="display:flex; justify-content:flex-end;">
                    <button id="re-vn-save-settings" style="background:#cba35c; color:#000; border:none; padding:8px 16px; border-radius:6px; font-weight:bold; cursor:pointer;">Close</button>
                </div>
            </div>
        </div>

        <div id="uie-mods-window" class="uie-window" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:min(700px, 92vw); height:min(800px, 92vh); background:#0b0f15; border:1px solid rgba(203,163,92,0.45); flex-direction:column; z-index:20050;">
            <div class="uie-header" style="border-bottom:1px solid rgba(255,255,255,0.12); padding:10px; background:linear-gradient(90deg, #1b202b, #0e121a); display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-family:'Cinzel',serif; color:#cba35c; letter-spacing:1px;">USER MODS</h3>
                <div class="uie-controls" style="display:flex; gap:10px;">
                    <button id="uie-mods-close" class="uie-close-btn" style="height:32px; width:32px; border-radius:8px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.06); color:#fff; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            <div style="padding:15px; display:flex; flex-direction:column; gap:15px; flex:1; overflow:hidden;">
                <div style="display:flex; gap:10px;">
                    <button id="uie-mods-import" style="flex:1; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.15); color:#ccc; padding:8px; border-radius:8px; cursor:pointer; font-weight:bold;"><i class="fa-solid fa-file-import"></i> Import</button>
                    <button id="uie-mods-export-all" style="flex:1; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.15); color:#ccc; padding:8px; border-radius:8px; cursor:pointer; font-weight:bold;"><i class="fa-solid fa-file-export"></i> Export All</button>
                </div>

                <div id="uie-mods-list" class="custom-scroll" style="flex:1; overflow-y:auto; border:1px solid rgba(255,255,255,0.1); background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                    <!-- Mods will be listed here -->
                    <div style="text-align:center; opacity:0.5; padding:20px;">No mods installed.</div>
                </div>

                <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                    <h4 style="margin:0 0 10px 0; color:#cba35c; font-size:14px;">CREATE NEW MOD</h4>
                    <div style="display:flex; gap:10px;">
                        <textarea id="uie-mods-prompt" placeholder="Describe what you want (e.g., 'A magic system with mana bars and spells')" style="flex:1; height:60px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.15); color:#fff; padding:10px; border-radius:8px; resize:none; font-family:inherit;"></textarea>
                        <button id="uie-mods-create" style="width:100px; background:#cba35c; color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px;">
                            <i class="fa-solid fa-wand-magic-sparkles" style="font-size:1.2em;"></i>
                            <span>Create</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="re-forge-modal">
            <div id="re-forge-card">
                <div style="display:flex; gap:10px; align-items:center;">
                    <div style="font-weight:900; letter-spacing:0.8px; color:rgba(205,127,50,0.98);">WORLD FORGE</div>
                    <button class="re-forge-btn" id="re-forge-close" style="margin-left:auto;"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div style="opacity:0.75; font-size:12px; margin-top:6px;">Edit the prompt, generate a background, then bind it to this location.</div>
                <textarea id="re-forge-prompt" placeholder="Describe the scene background..."></textarea>
                <div class="re-forge-row">
                    <button class="re-forge-btn primary" id="re-forge-generate"><i class="fa-solid fa-wand-magic-sparkles"></i>&nbsp;Generate</button>
                    <button class="re-forge-btn" id="re-forge-bind"><i class="fa-solid fa-floppy-disk"></i>&nbsp;Save/Bind</button>
                </div>
                <div id="re-forge-preview">
                    <img id="re-forge-img" alt="">
                    <div id="re-forge-empty" style="opacity:0.7; font-weight:900;">No preview yet</div>
                </div>
            </div>
        </div>
    </div>
</div>


