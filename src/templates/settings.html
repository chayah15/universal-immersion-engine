<div class="uie-settings-block">
    <style>
        .uie-settings-drawer { display: flex !important; flex-direction: column !important; }
        .uie-settings-drawer > div:first-child { flex: 0 0 auto !important; }
        .uie-settings-drawer > div[id^="uie-set-"] { flex: 1 1 auto !important; min-height: 0 !important; overflow-y: auto !important; -webkit-overflow-scrolling: touch !important; }
    </style>
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Universal Immersion Engine</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content uie-settings-drawer" style="max-height:80vh !important; height:80vh !important; overflow-y:auto !important; overflow-x:hidden !important; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; touch-action: pan-y; padding-bottom:16px; min-height:0;">
            <div style="display:flex; gap:6px; border-bottom:1px solid #444; margin-bottom:10px; overflow-x:auto; overflow-y:hidden; white-space:nowrap;">
                <div class="uie-set-tab active" data-tab="general" style="flex:0 0 auto; padding:5px 10px; cursor:pointer; font-weight:bold; color:#fff; border-bottom:2px solid #cba35c; white-space:nowrap;">General</div>
                <div class="uie-set-tab" data-tab="turbo" style="flex:0 0 auto; padding:5px 10px; cursor:pointer; color:#888; white-space:nowrap;">Turbo API</div>
                <div class="uie-set-tab" data-tab="automation" style="flex:0 0 auto; padding:5px 10px; cursor:pointer; color:#888; white-space:nowrap;">Automation</div>
                <div class="uie-set-tab" data-tab="profiles" style="flex:0 0 auto; padding:5px 10px; cursor:pointer; color:#888; white-space:nowrap;">Presets</div>
                <div class="uie-set-tab" data-tab="prompts" style="flex:0 0 auto; padding:5px 10px; cursor:pointer; color:#888; white-space:nowrap;">Prompts</div>
                <div class="uie-set-tab" data-tab="popups" style="flex:0 0 auto; padding:5px 10px; cursor:pointer; color:#888; white-space:nowrap;">Popups</div>
            </div>
            <div id="uie-set-general">
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                    <div style="font-weight:bold; color:#ccc; margin-bottom:8px; font-size:0.9em;">Full Character State (Internal)</div>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <select class="uie-state-select" style="flex:1; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                            <option value="">(Select Save...)</option>
                        </select>
                        <button class="uie-state-load-btn" style="width:60px; height:36px; background:rgba(52,152,219,0.15); border:1px solid rgba(52,152,219,0.4); color:#3498db; border-radius:8px; cursor:pointer; font-weight:bold;">Load</button>
                        <button class="uie-state-del-btn" style="width:40px; height:36px; background:rgba(231,76,60,0.15); border:1px solid rgba(231,76,60,0.4); color:#e74c3c; border-radius:8px; cursor:pointer; font-weight:bold;"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <input type="text" class="uie-state-name" placeholder="Save Name..." style="flex:1; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                        <button class="uie-state-save-btn" style="width:60px; height:36px; background:rgba(46,204,113,0.15); border:1px solid rgba(46,204,113,0.4); color:#2ecc71; border-radius:8px; cursor:pointer; font-weight:bold;">Save</button>
                    </div>
                    <div style="font-size:0.75em; color:#888; margin-top:4px;">Saves entire state to UIE memory (Databank, Social, Inventory, etc).</div>
                </div>
                <div class="uie-control-group" style="display:flex; align-items:center; margin-bottom:10px;">
                    <label style="flex:1;">Kill Switch (Disable UIE Overlay)</label>
                    <input type="checkbox" id="uie-setting-enable">
                </div>
                <div class="uie-control-group" style="display:flex; align-items:center; margin-bottom:10px;">
                    <label style="flex:1;">Enable Scan All (UIE State Scan)</label>
                    <input type="checkbox" id="uie-scanall-enable">
                </div>
                <div class="uie-control-group" style="display:flex; align-items:center; margin-bottom:10px;">
                    <label style="flex:1;">Allow System Checks (AI)</label>
                    <input type="checkbox" id="uie-systemchecks-enable">
                </div>
                <div class="uie-control-group"><label>UI Scale: <span id="uie-scale-display">1.0</span>x</label><input type="range" id="uie-scale-slider" min="0.5" max="1.5" step="0.1" value="1.0" style="width:100%;"></div>
                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="display:block; margin-bottom:6px;">Show Popup Notifications</label>
                    <div class="uie-control-group" style="display:flex; align-items:center;">
                        <input type="checkbox" id="uie-show-popups">
                        <span style="font-size:0.8em; color:#888; margin-left:10px;">(e.g. Loot, API usage, etc)</span>
                    </div>
                </div>
                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="display:block; margin-bottom:6px;">Launcher Name</label>
                    <input type="text" id="uie-launcher-name" placeholder="Menu" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                </div>
                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="display:block; margin-bottom:6px;">Launcher Icon</label>
                    <div style="display:flex; gap:5px;">
                        <select id="uie-launcher-icon" style="flex:1; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            <option value="custom">Custom (Upload)</option>
                            <option value="https://user.uploads.dev/file/b3fc92e1b70f0c8f0c200b544f7a4cce.png">Adventure Pack</option>
                            <option value="https://user.uploads.dev/file/7a2192ad45ab864d13570e54d1f2fbe3.png">Gear</option>
                            <option value="https://user.uploads.dev/file/b2121592871d90a03dd246f41f8fe452.png">Sword</option>
                            <option value="https://user.uploads.dev/file/a9cef63039cb7c9fe2950b2a279e486d.png">Fantasy Scroll</option>
                            <option value="https://user.uploads.dev/file/d0ab82cdfafc169c41c8ff7be6932710.png">Emerald Pouch</option>
                            <option value="https://user.uploads.dev/file/46e20ac002586b8bef879905ce564c75.png">Shield & Crow</option>
                            <option value="https://user.uploads.dev/file/3356b35675ee7ee139dd605827c5c6ea.png">Zombie Apocalypse</option>
                            <option value="https://user.uploads.dev/file/081cbcc0d71cbdfa35ec4465b10de41e.png">???</option>
                        </select>
                        <button id="uie-launcher-save" title="Save Icon" style="width:44px; background:#333; border:1px solid #555; color:#fff; border-radius:6px; cursor:pointer;">Save</button>
                        <button id="uie-launcher-delete" title="Delete Saved Icon" style="width:44px; background:#333; border:1px solid #555; color:#fff; border-radius:6px; cursor:pointer;">Del</button>
                    </div>
                    <input type="file" id="uie-launcher-file" accept="image/*" style="display:none;">
                    <div id="uie-launcher-preview" style="margin-top:5px; height:40px; width:40px; border-radius:50%; background-size:cover; background-position:center; display:none; border:2px solid #cba35c;"></div>
                </div>
            </div>
            <div id="uie-set-turbo" style="display:none;">
                <div style="font-size:0.8em; color:#ccc; margin-bottom:10px;">Use a faster model (Gemini Flash/DeepSeek) for Phone/Inventory events to save main context.</div>
                <div class="uie-control-group"><label style="font-size:0.8em;">Enable Turbo</label><input type="checkbox" id="uie-turbo-enable"></div>
                <div class="uie-control-group" style="margin-top:6px;">
                    <label style="font-size:0.8em;">Quick Preset</label>
                    <div style="display:flex; gap:6px;">
                        <select id="uie-turbo-preset" style="flex:1; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                            <option value="openrouter">OpenRouter</option>
                            <option value="nanogpt">NanoGPT</option>
                            <option value="nvidia_nim">NVIDIA NIM</option>
                            <option value="custom">Custom</option>
                        </select>
                        <button id="uie-turbo-preset-apply" title="Apply Preset" style="width:44px; background:#333; border:1px solid #555; color:#fff; border-radius:8px; cursor:pointer;">↻</button>
                    </div>
                </div>
                <div class="uie-control-group"><label style="font-size:0.8em;">Endpoint</label><input type="text" id="uie-turbo-url" placeholder="https://openrouter.ai/api/v1/chat/completions (or http://127.0.0.1:1234/v1 , or https://integrate.api.nvidia.com/v1)" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                <div style="font-size:0.75em; color:#888; margin-top:6px;">Local endpoints (localhost/127.0.0.1) are supported; API Key can be left blank if your local server does not require auth. If you see “Failed to fetch”, enable SillyTavern's CORS proxy (enableCorsProxy) or use a local gateway.</div>
                <div class="uie-control-group"><label style="font-size:0.8em;">API Key</label><input type="password" id="uie-turbo-key" placeholder="sk-..." style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                <div class="uie-control-group" style="margin-top:8px;">
                    <label style="font-size:0.8em;">Model</label>
                    <div style="display:flex; gap:6px;">
                        <select id="uie-turbo-model-select" style="flex:1; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            <option value="">(Refresh to load models)</option>
                            <option value="__custom__">Custom…</option>
                        </select>
                        <button id="uie-turbo-model-refresh" title="Refresh Models" style="width:44px; background:#333; border:1px solid #555; color:#fff; border-radius:8px; cursor:pointer;">↻</button>
                    </div>
                </div>
                <div class="uie-control-group"><label style="font-size:0.8em;">Custom Model ID</label><input type="text" id="uie-turbo-model" placeholder="google/gemini-2.0-flash-exp" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                <button id="uie-turbo-test" style="margin-top:10px; width:100%; background:#333; border:1px solid #555; color:#fff; cursor:pointer;">Test Connection</button>
                
                <hr style="border-color:#333; margin:15px 0;">
                <div style="font-weight:bold; color:#ccc; margin-bottom:8px; font-size:0.9em;">Image Generation API</div>
                <div class="uie-control-group"><label style="font-size:0.8em;">Enable Images</label><input type="checkbox" id="uie-img-enable"></div>
                <div class="uie-control-group" style="margin-top:6px;">
                    <label style="font-size:0.8em;">Provider</label>
                    <select id="uie-img-provider" style="width:100%; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                        <option value="openai">OpenAI-compatible (DALL·E / gpt-image-1)</option>
                        <option value="comfy">ComfyUI (Local)</option>
                        <option value="sdwebui">SD WebUI (Local)</option>
                        <option value="custom">Custom / Advanced</option>
                    </select>
                </div>

                <div id="uie-img-openai-block" style="margin-top:8px;">
                    <div class="uie-control-group" style="margin-top:2px;">
                        <label style="font-size:0.8em;">Quick Preset</label>
                        <div style="display:flex; gap:6px;">
                            <select id="uie-img-preset" style="flex:1; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                                <option value="openai">OpenAI</option>
                                <option value="nanogpt">NanoGPT</option>
                                <option value="nvidia_nim">NVIDIA NIM (OpenAI-compatible)</option>
                                <option value="custom">Custom</option>
                            </select>
                            <button id="uie-img-preset-apply" title="Apply Preset" style="width:44px; background:#333; border:1px solid #555; color:#fff; border-radius:8px; cursor:pointer;">↻</button>
                        </div>
                    </div>
                    <div class="uie-control-group"><label style="font-size:0.8em;">Endpoint</label><input type="text" id="uie-img-url" placeholder="https://api.openai.com/v1/images/generations" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                    <div class="uie-control-group"><label style="font-size:0.8em;">API Key</label><input type="password" id="uie-img-key" placeholder="sk-..." style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                    <div class="uie-control-group" style="margin-top:8px;">
                        <label style="font-size:0.8em;">Model</label>
                        <select id="uie-img-model-select" style="width:100%; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                            <option value="dall-e-3">dall-e-3</option>
                            <option value="gpt-image-1">gpt-image-1</option>
                            <option value="dall-e-2">dall-e-2</option>
                            <option value="hidream">hidream (NanoGPT)</option>
                            <option value="stabilityai/stable-diffusion-3.5-large">stabilityai/stable-diffusion-3.5-large</option>
                            <option value="stabilityai/stable-diffusion-3.5-large-turbo">stabilityai/stable-diffusion-3.5-large-turbo</option>
                            <option value="__custom__">Custom…</option>
                        </select>
                    </div>
                    <div class="uie-control-group"><label style="font-size:0.8em;">Custom Model ID</label><input type="text" id="uie-img-model" placeholder="dall-e-3" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                </div>

                <div id="uie-img-comfy-block" style="display:none; margin-top:8px;">
                    <div style="font-size:0.75em; color:#888; margin-bottom:6px;">ComfyUI Easy Setup: set your local URL, pick a checkpoint, click Apply.</div>
                    <div class="uie-control-group"><label style="font-size:0.8em;">ComfyUI URL</label><input type="text" id="uie-img-comfy-base" placeholder="http://127.0.0.1:8188" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                    <div class="uie-control-group"><label style="font-size:0.8em;">ComfyUI API Key (RunPod/Cloud)</label><input type="password" id="uie-img-comfy-key" data-key="api_key_comfy_runpod" placeholder="Optional" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                    <div class="uie-control-group" style="margin-top:8px;">
                        <label style="font-size:0.8em;">Checkpoint</label>
                        <div style="display:flex; gap:6px;">
                            <select id="uie-img-comfy-ckpt" style="flex:1; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                                <option value="">(Click refresh to detect)</option>
                            </select>
                            <button id="uie-img-comfy-ckpt-refresh" title="Detect Checkpoints" style="width:44px; background:#333; border:1px solid #555; color:#fff; border-radius:8px; cursor:pointer;">↻</button>
                        </div>
                    </div>
                    <div class="uie-control-group" style="margin-top:8px;">
                        <label style="font-size:0.8em;">Quality</label>
                        <select id="uie-img-comfy-quality" style="width:100%; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                            <option value="fast">Fast (512, 16 steps)</option>
                            <option value="balanced" selected>Balanced (768, 24 steps)</option>
                            <option value="hq">HQ (1024, 32 steps)</option>
                        </select>
                    </div>
                    <div style="margin-top:10px; border:1px solid rgba(255,255,255,0.10); border-radius:10px; padding:10px; background:rgba(0,0,0,0.16);">
                        <div style="font-weight:900; color:#ddd; margin-bottom:8px; font-size:0.8em;">ComfyUI Generation Settings (SillyTavern-style)</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Sampling method</label>
                                <select id="uie-img-comfy-sampler" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                                    <option value="euler_ancestral">euler_ancestral</option>
                                    <option value="euler">euler</option>
                                    <option value="ddim">ddim</option>
                                    <option value="dpmpp_2m">dpmpp_2m</option>
                                    <option value="dpmpp_2m_sde">dpmpp_2m_sde</option>
                                    <option value="dpmpp_sde">dpmpp_sde</option>
                                    <option value="dpmpp_3m_sde">dpmpp_3m_sde</option>
                                </select>
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Scheduler</label>
                                <select id="uie-img-comfy-scheduler" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                                    <option value="normal">normal</option>
                                    <option value="karras">karras</option>
                                    <option value="exponential">exponential</option>
                                    <option value="sgm_uniform">sgm_uniform</option>
                                    <option value="ddim_uniform">ddim_uniform</option>
                                    <option value="simple">simple</option>
                                    <option value="beta">beta</option>
                                    <option value="linear_quadratic">linear_quadratic</option>
                                    <option value="kl_optimal">kl_optimal</option>
                                    <option value="boing_tangent">boing_tangent</option>
                                    <option value="beta57">beta57</option>
                                </select>
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Sampling steps</label>
                                <input type="number" id="uie-img-comfy-steps" min="1" step="1" placeholder="24" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">CFG scale</label>
                                <input type="number" id="uie-img-comfy-cfg" min="0" step="0.1" placeholder="7" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Width</label>
                                <input type="number" id="uie-img-comfy-width" min="64" step="8" placeholder="768" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Height</label>
                                <input type="number" id="uie-img-comfy-height" min="64" step="8" placeholder="768" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Denoising strength</label>
                                <input type="number" id="uie-img-comfy-denoise" min="0" max="1" step="0.01" placeholder="1.0" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Seed (-1 random)</label>
                                <input type="number" id="uie-img-comfy-seed" step="1" placeholder="-1" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px;">
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Common prompt prefix</label>
                                <input type="text" id="uie-img-comfy-common" placeholder="" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                            <div class="uie-control-group" style="margin:0;">
                                <label style="font-size:0.78em;">Negative common prompt prefix</label>
                                <input type="text" id="uie-img-comfy-common-neg" placeholder="" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            </div>
                        </div>
                    </div>
                    <div class="uie-control-group"><label style="font-size:0.8em;">Negative Prompt (optional)</label><input type="text" id="uie-img-negative" placeholder="blurry, low quality" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                    <button id="uie-img-comfy-apply" style="margin-top:8px; width:100%; background:#333; border:1px solid #555; color:#fff; cursor:pointer;">Apply ComfyUI Easy Setup</button>
                </div>

                <div id="uie-img-sdwebui-block" style="display:none; margin-top:8px;">
                    <div style="font-size:0.75em; color:#888; margin-bottom:6px;">SD WebUI: use the txt2img API URL (no key needed for local).</div>
                    <div class="uie-control-group"><label style="font-size:0.8em;">SD WebUI txt2img URL</label><input type="text" id="uie-img-sdwebui-url" placeholder="http://127.0.0.1:7860/sdapi/v1/txt2img" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                </div>

                <details id="uie-img-advanced" style="margin-top:10px;">
                    <summary style="cursor:pointer; color:#bbb; font-weight:900;">Advanced (optional)</summary>
                    <div style="margin-top:8px;">
                        <div class="uie-control-group"><label style="font-size:0.8em;">Endpoint</label><input type="text" id="uie-img-url-adv" placeholder="(auto)" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                        <div class="uie-control-group"><label style="font-size:0.8em;">API Key</label><input type="password" id="uie-img-key-adv" placeholder="(auto)" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                        <div class="uie-control-group"><label style="font-size:0.8em;">Model</label><input type="text" id="uie-img-model-adv" placeholder="(auto)" style="width:100%; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                        <div class="uie-control-group" style="margin-top:10px;">
                            <label style="font-size:0.8em;">ComfyUI Workflow JSON</label>
                            <textarea id="uie-img-comfy-workflow" placeholder='Paste ComfyUI API workflow JSON here. Use {{prompt}}, {{negative_prompt}}, and {{checkpoint}} placeholders.' style="width:100%; min-height:120px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:6px; margin-top:8px;">
                            <input type="text" id="uie-img-comfy-posnode" placeholder="Positive node ID" style="background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            <input type="text" id="uie-img-comfy-negnode" placeholder="Negative node ID" style="background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                            <input type="text" id="uie-img-comfy-outnode" placeholder="Output node ID (optional)" style="background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;">
                        </div>
                    </div>
                </details>

                <button id="uie-img-test" style="margin-top:10px; width:100%; background:rgba(241,196,15,0.14); border:1px solid rgba(241,196,15,0.4); color:#f1c40f; cursor:pointer;">Test Image</button>
                
                <div style="margin-top:10px; font-size:0.8em; color:#888;">Features (Toggle per feature):</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <label style="font-size:0.75em; color:#aaa;"><input type="checkbox" id="uie-img-map"> Map</label>
                    <label style="font-size:0.75em; color:#aaa;"><input type="checkbox" id="uie-img-doll"> Paper Doll</label>
                    <label style="font-size:0.75em; color:#aaa;"><input type="checkbox" id="uie-img-social"> Social Photos</label>
                    <label style="font-size:0.75em; color:#aaa;"><input type="checkbox" id="uie-img-phone-bg"> Phone BG</label>
                    <label style="font-size:0.75em; color:#aaa;"><input type="checkbox" id="uie-img-msg"> Messages</label>
                    <label style="font-size:0.75em; color:#aaa;"><input type="checkbox" id="uie-img-party"> Party</label>
                    <label style="font-size:0.75em; color:#aaa;"><input type="checkbox" id="uie-img-items"> Items</label>
                </div>
            </div>
            <div id="uie-set-automation" style="display:none;">
                <div style="font-size:0.85em; color:#ccc; margin-bottom:10px;">
                    Toggle AI generation per menu. These only affect AI calls; local features still work.
                </div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Phone Browser Pages</label><input type="checkbox" id="uie-ai-phone-browser"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Phone Messages Replies</label><input type="checkbox" id="uie-ai-phone-messages"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Phone Calls</label><input type="checkbox" id="uie-ai-phone-calls"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">App Builder</label><input type="checkbox" id="uie-ai-app-builder"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Book Generator</label><input type="checkbox" id="uie-ai-books"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Journal Quest Generator</label><input type="checkbox" id="uie-ai-journal-quests"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Databank Scan</label><input type="checkbox" id="uie-ai-databank"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Map Generator</label><input type="checkbox" id="uie-ai-map"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Shop Generator</label><input type="checkbox" id="uie-ai-shop"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Auto-Detect Loot & Status</label><input type="checkbox" id="uie-ai-loot"></div>
                <hr style="border-color:#333; margin:10px 0;">
                <div style="font-size:0.85em; color:#ccc; margin-bottom:8px;">Fabricator UX</div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Require Confirm for Unverified Saves</label><input type="checkbox" id="uie-gen-require-confirm"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Show Prompt Box</label><input type="checkbox" id="uie-gen-show-prompt"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Confirm Before Any AI Call</label><input type="checkbox" id="uie-ai-confirm-toggle"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Scan only on Send/Continue/Regenerate</label><input type="checkbox" id="uie-gen-scan-only-buttons"></div>
                <div class="uie-control-group" style="margin-top:8px;"><label style="font-size:0.85em;">System Check Cooldown (sec)</label><input type="number" id="uie-gen-syscheck-min" min="0" step="1" style="width:120px; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Auto Scan Cooldown (sec)</label><input type="number" id="uie-gen-autoscan-min" min="0" step="1" style="width:120px; background:#222; border:1px solid #444; color:#fff; padding:3px;"></div>
                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="font-size:0.85em; display:block; margin-bottom:6px;">Overall System Prompt (Injected First)</label>
                    <textarea id="uie-gen-custom-system" placeholder="Optional. This is injected at the highest priority into every generation." style="width:100%; min-height:120px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                </div>
                <hr style="border-color:#333; margin:10px 0;">
                <div class="uie-control-group"><label style="font-size:0.85em;">Enable Codex (Lore Encyclopedia)</label><input type="checkbox" id="uie-feature-codex"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Auto-Extract Codex from Chat</label><input type="checkbox" id="uie-feature-codex-auto"></div>
            </div>

            <div id="uie-set-profiles" style="display:none;">
                <div style="font-size:0.85em; color:#ccc; margin-bottom:10px;">
                    SillyTavern Connection Presets (Main API)
                </div>
                <div style="display:flex; gap:6px;">
                    <select id="uie-st-preset-select" style="flex:1; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px;">
                        <option value="">(Loading...)</option>
                    </select>
                    <button id="uie-st-preset-refresh" title="Refresh Presets" style="width:44px; background:#333; border:1px solid #555; color:#fff; border-radius:8px; cursor:pointer;">↻</button>
                </div>
                <div style="margin-top:10px; font-size:0.8em; color:#888;">
                    Select a preset to instantly switch SillyTavern's main connection settings.
                </div>
                <!-- Hidden fallback selector if needed for logic, though we use the main one directly now -->
            </div>

            <div id="uie-set-rpg" style="display:none;">
                <div style="font-size:0.85em; color:#ccc; margin-bottom:10px;">
                    RPG Mechanics & Display Settings
                </div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Enable RPG Mechanics (XP/Levels)</label><input type="checkbox" id="uie-rpg-enable"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Show XP Bar in Menu</label><input type="checkbox" id="uie-rpg-xpbar"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Enable Equipment System</label><input type="checkbox" id="uie-rpg-equipment"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Enable Skills System</label><input type="checkbox" id="uie-rpg-skills"></div>
                <div class="uie-control-group"><label style="font-size:0.85em;">Enable Party System</label><input type="checkbox" id="uie-rpg-party"></div>
            </div>

            <div id="uie-set-css" style="display:none;">
                <div style="font-size:0.85em; color:#ccc; margin-bottom:10px;">
                    Global Custom CSS (Applied to UIE overlay)
                </div>
                <textarea id="uie-custom-css" placeholder=".uie-window { background: black !important; }" style="width:100%; min-height:150px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical; font-family:monospace;"></textarea>
                
                <div style="font-size:0.85em; color:#ccc; margin:10px 0 5px;">Stats Window CSS (Scoped to #uie-stats-window)</div>
                <textarea id="uie-custom-css-stats" placeholder=".uie-stat-card { background: red; }" style="width:100%; min-height:100px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical; font-family:monospace;"></textarea>

                <div style="font-size:0.85em; color:#ccc; margin:10px 0 5px;">Activities Window CSS (Scoped to #uie-activities-window)</div>
                <textarea id="uie-custom-css-activities" placeholder=".uie-sim-card { border: 1px solid blue; }" style="width:100%; min-height:100px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical; font-family:monospace;"></textarea>

                <button id="uie-custom-css-apply" style="margin-top:8px; width:100%; background:#333; border:1px solid #555; color:#fff; cursor:pointer;">Apply CSS</button>
            </div>

            <div id="uie-set-prompts" style="display:none;">
                <div style="font-size:0.85em; color:#ccc; margin-bottom:10px;">
                    These are extra prompt prefixes UIE injects into feature generations. Keep them short for best compatibility.
                </div>

                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="font-size:0.85em; display:block; margin-bottom:6px;">Global Prompt Prefix (All UIE Generations)</label>
                    <textarea id="uie-gen-prompt-global" placeholder="Optional. Extra instructions applied to every UIE generation." style="width:100%; min-height:120px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                </div>

                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="font-size:0.85em; display:block; margin-bottom:6px;">Default Prompt Prefix (Fallback For Any Type)</label>
                    <textarea id="uie-gen-prompt-default" placeholder="Optional. Applied when no type-specific prompt exists." style="width:100%; min-height:90px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                </div>

                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="font-size:0.85em; display:block; margin-bottom:6px;">Webpage Prompt Prefix (HTML generators)</label>
                    <textarea id="uie-gen-prompt-webpage" placeholder="Optional. Extra rules for HTML-only generations." style="width:100%; min-height:90px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                </div>

                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="font-size:0.85em; display:block; margin-bottom:6px;">System Check Prompt Prefix (JSON generators)</label>
                    <textarea id="uie-gen-prompt-systemcheck" placeholder="Optional. Extra rules for JSON-only generations (System Check + Shop)." style="width:100%; min-height:90px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                </div>

                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="font-size:0.85em; display:block; margin-bottom:6px;">Phone Call Prompt Prefix</label>
                    <textarea id="uie-gen-prompt-phonecall" placeholder="Optional. Extra rules for phone call dialogue generation." style="width:100%; min-height:90px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                </div>

                <div class="uie-control-group" style="margin-top:10px;">
                    <label style="font-size:0.85em; display:block; margin-bottom:6px;">Image Gen Prompt Prefix</label>
                    <textarea id="uie-gen-prompt-image" placeholder="Optional. Extra rules for image generation prompts." style="width:100%; min-height:90px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                </div>

                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button id="uie-gen-prompts-clear" style="flex:0 0 auto; width:160px; background:rgba(255,255,255,0.06); border:1px solid #555; color:#fff; cursor:pointer;">Clear Prompts</button>
                </div>
            </div>

            <div id="uie-set-popups" style="display:none;">
                <div style="font-size:0.85em; color:#ccc; margin-bottom:10px;">
                    Customize UIE notifications (style + which events can notify).
                </div>

                <div class="uie-control-group" style="display:flex; align-items:center; margin-bottom:10px;">
                    <label style="flex:1;">Enable Popups (Master)</label>
                    <input type="checkbox" id="uie-show-popups">
                </div>

                <div style="font-weight:bold; color:#ccc; margin:10px 0 8px; font-size:0.9em;">Popup Style (CSS)</div>
                <select id="uie-popup-css-scope" style="width:100%; height:36px; background:#222; border:1px solid #444; color:#fff; padding:0 10px; border-radius:8px; margin-bottom:8px;">
                    <option value="global">Global</option>
                    <option value="questsAccepted">Quests (Accepted)</option>
                    <option value="questsAbandoned">Quests (Abandoned)</option>
                    <option value="questsFailed">Quests (Failed)</option>
                    <option value="questsCompleted">Quests (Completed)</option>
                    <option value="phoneCalls">Phone Calls</option>
                    <option value="phoneMessages">Phone Messages</option>
                    <option value="loot">Loot</option>
                    <option value="currency">Currency</option>
                    <option value="xp">XP</option>
                    <option value="levelUp">Level Up</option>
                    <option value="postBattle">Post Battle</option>
                    <option value="api">API</option>
                    <option value="social">Social</option>
                    <option value="lowHp">Low HP</option>
                </select>
                <textarea id="uie-popup-css-text" placeholder="Optional: custom CSS for toastr popups (advanced)." style="width:100%; min-height:140px; background:#222; border:1px solid #444; color:#fff; padding:8px; border-radius:8px; resize:vertical;"></textarea>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button id="uie-popup-css-apply" style="flex:1; background:#333; border:1px solid #555; color:#fff; cursor:pointer;">Apply Popup CSS</button>
                    <button id="uie-popup-css-reset" style="flex:0 0 auto; width:120px; background:rgba(255,255,255,0.06); border:1px solid #555; color:#fff; cursor:pointer;">Reset</button>
                </div>
                <button id="uie-popup-test" style="margin-top:8px; width:100%; background:rgba(241,196,15,0.14); border:1px solid rgba(241,196,15,0.4); color:#f1c40f; cursor:pointer;">Test Popup</button>

                <hr style="border-color:#333; margin:15px 0;">

                <div style="font-weight:bold; color:#ccc; margin-bottom:8px; font-size:0.9em;">Quest Popups</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-quests-accepted"> Accepted</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-quests-abandoned"> Abandoned</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-quests-failed"> Failed</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-quests-completed"> Completed</label>
                </div>

                <div style="font-weight:bold; color:#ccc; margin:12px 0 8px; font-size:0.9em;">Phone Popups</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-phone-calls"> Calls</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-phone-messages"> Messages</label>
                </div>

                <div style="font-weight:bold; color:#ccc; margin:12px 0 8px; font-size:0.9em;">Inventory Popups</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-loot"> Loot</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-currency"> Currency</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-xp"> XP</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-levelup"> Level Up</label>
                </div>

                <div style="font-weight:bold; color:#ccc; margin:12px 0 8px; font-size:0.9em;">Combat Popups</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-postbattle"> Post-battle rewards</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-postbattle-generate"> Auto-generate rewards</label>
                </div>

                <div style="font-weight:bold; color:#ccc; margin:12px 0 8px; font-size:0.9em;">Health Popups</div>
                <div class="uie-control-group" style="display:flex; align-items:center; gap:10px;">
                    <label style="flex:1; font-size:0.85em; color:#aaa;"><input type="checkbox" id="uie-pop-lowhp-enabled"> Low HP warning</label>
                    <input type="number" id="uie-pop-lowhp-threshold" min="0.05" max="0.9" step="0.05" style="width:110px; background:#222; border:1px solid #444; color:#fff; padding:6px; border-radius:8px;" placeholder="0.25">
                </div>

                <div style="font-weight:bold; color:#ccc; margin:12px 0 8px; font-size:0.9em;">Other Popups</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-api"> API / Generation</label>
                    <label style="font-size:0.8em; color:#aaa;"><input type="checkbox" id="uie-pop-social"> Social</label>
                </div>
            </div>
        </div>
    </div>
</div>
