<style>
  #uie-battle-window{ top: 80px; left: 80px; transform:none; }
  @media (max-width: 700px), (pointer: coarse) {
    #uie-battle-window {
      position: fixed !important;
      inset: auto !important;
      top: 12vh !important;
      left: 3vw !important;
      transform: none !important;
      width: 94vw !important;
      height: 80vh !important;
      max-width: 94vw !important;
      max-height: 80vh !important;
    }
  }
</style>
<div id="uie-battle-window" class="uie-window" style="display:none; width:min(780px, 92vw); height:min(760px, 92vh); background:#0b0f15; border:1px solid rgba(203,163,92,0.45);">
  <div class="uie-header" style="border-bottom:1px solid rgba(203,163,92,0.35); background:linear-gradient(90deg,#1b202b,#0e121a);">
    <div class="uie-info">
      <h2 style="margin:0; font-family:serif; color:#cba35c; letter-spacing:1px;">War Room</h2>
      <div style="font-size:12px; color:#aaa;" id="uie-battle-sub">Battle tracker</div>
    </div>
    <div class="uie-controls" style="margin-left:auto; display:flex; gap:10px; align-items:center;">
      <button id="uie-battle-wand" title="Tools" style="height:34px; width:44px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.25); color:#fff; font-weight:900; cursor:pointer; touch-action:manipulation;"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
      <button id="uie-battle-dice-roll" title="Roll Dice" style="height:34px; width:44px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(203,163,92,0.18); color:#cba35c; font-weight:900; cursor:pointer; touch-action:manipulation;"><i class="fa-solid fa-dice-d20"></i></button>
      <button id="uie-battle-close" title="Close" style="height:34px; width:44px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.25); color:#fff; font-weight:900; cursor:pointer; touch-action:manipulation;"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="uie-dropdown" id="uie-battle-menu" style="position:absolute; top:44px; right:44px; background:#111; border:1px solid rgba(203,163,92,0.5); border-radius:10px; padding:6px; display:none; flex-direction:column; gap:6px; z-index:2147483647; min-width:210px;">
      <div class="uie-dd-item" onclick="uie.phone.openBooksGuide('guide-warroom')" style="display:flex; gap:10px; align-items:center; padding:10px 10px; border-radius:10px; cursor:pointer; font-weight:900; color:#cba35c; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08);"><i class="fa-solid fa-circle-question"></i> Help / Guide</div>
      <div class="uie-dd-item" id="uie-battle-scan" style="display:flex; gap:10px; align-items:center; padding:10px 10px; border-radius:10px; cursor:pointer; font-weight:900; color:#fff; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08);"><i class="fa-solid fa-users-viewfinder"></i> Scan</div>
      <div class="uie-dd-item" id="uie-battle-auto" style="display:flex; gap:10px; align-items:center; padding:10px 10px; border-radius:10px; cursor:pointer; font-weight:900; color:#fff; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08);"><i class="fa-solid fa-robot"></i> Auto Scan: <span id="uie-battle-auto-state" style="margin-left:auto; opacity:0.85;">OFF</span></div>
      <div class="uie-dd-item" id="uie-battle-dice-toggle" style="display:flex; gap:10px; align-items:center; padding:10px 10px; border-radius:10px; cursor:pointer; font-weight:900; color:#fff; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08);"><i class="fa-solid fa-dice-d20"></i> Dice: <span id="uie-battle-dice-state" style="margin-left:auto; opacity:0.85;">OFF</span></div>
    </div>
  </div>

  <div class="uie-content" style="padding:12px; overflow:auto; height:calc(100% - 54px); display:grid; grid-template-columns: 1fr; gap:12px;">
    <div style="border-radius:18px; border:1px solid rgba(255,255,255,0.10); background:radial-gradient(120% 120% at 40% 20%, rgba(40,24,16,0.55) 0%, rgba(10,6,5,0.70) 60%, rgba(0,0,0,0.82) 100%); padding:12px;">
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px; border-radius:16px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.20); padding:12px;">
          <div style="font-weight:900; color:#f1c40f; margin-bottom:10px;">Enemies</div>
          <div id="uie-battle-enemies"></div>
        </div>
        <div style="flex:1; min-width:260px; border-radius:16px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.20); padding:12px;">
          <div style="font-weight:900; color:#89b4fa; margin-bottom:10px;">Turn Order</div>
          <div id="uie-battle-turn"></div>
        </div>
      </div>
    </div>

    <div style="border-radius:18px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.22); padding:12px;">
      <div style="font-weight:900; color:#cba35c; margin-bottom:10px;">Battle Log</div>
      <div id="uie-battle-log" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; line-height:1.45; white-space:pre-wrap; color:rgba(255,255,255,0.82);"></div>
    </div>
  </div>
</div>

<template id="uie-battle-enemy-row">
    <div style="padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.18); margin-bottom:8px;">
        <div style="display:flex; gap:10px; align-items:center;">
            <div style="font-weight:900; color:#fff; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                <span class="en-name"></span> <span class="en-boss" style="color:#f38ba8; display:none;">(BOSS)</span>
            </div>
            <div class="en-hp-text" style="opacity:0.75; font-size:12px; font-weight:900;"></div>
        </div>
        <div style="height:10px; border-radius:999px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); overflow:hidden; margin-top:8px;">
            <div class="en-bar-fill" style="height:100%; width:0%; background:linear-gradient(90deg,#e74c3c,#f1c40f);"></div>
        </div>
        <div class="en-fx" style="margin-top:8px; opacity:0.85; font-size:12px;"></div>
    </div>
</template>

<template id="uie-battle-turn-row">
    <div class="turn-text" style="padding:8px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.18); font-weight:900; color:#fff;"></div>
</template>
